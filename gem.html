<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK Company FSM Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 800px;
        }
        .loading-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }
        .dot-pulse {
            position: relative;
            left: -9999px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #4f46e5;
            color: #4f46e5;
            box-shadow: 9999px 0 0 -5px;
            animation: dot-pulse 1.5s infinite linear;
            animation-delay: 0.25s;
        }
        .dot-pulse::before, .dot-pulse::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #4f46e5;
            color: #4f46e5;
        }
        .dot-pulse::before {
            box-shadow: 9984px 0 0 -5px;
            animation: dot-pulse-before 1.5s infinite linear;
            animation-delay: 0s;
        }
        @keyframes dot-pulse-before {
            0% { box-shadow: 9984px 0 0 -5px; }
            30% { box-shadow: 9984px 0 0 2px; }
            60%, 100% { box-shadow: 9984px 0 0 -5px; }
        }
        .dot-pulse::after {
            box-shadow: 10014px 0 0 -5px;
            animation: dot-pulse-after 1.5s infinite linear;
            animation-delay: 0.5s;
        }
        @keyframes dot-pulse {
            0% { box-shadow: 9999px 0 0 -5px; }
            30% { box-shadow: 9999px 0 0 2px; }
            60%, 100% { box-shadow: 9999px 0 0 -5px; }
        }
        @keyframes dot-pulse-after {
            0% { box-shadow: 10014px 0 0 -5px; }
            30% { box-shadow: 10014px 0 0 2px; }
            60%, 100% { box-shadow: 10014px 0 0 -5px; }
        }
    </style>
</head>
<body class="p-6 bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container bg-white p-8 rounded-2xl shadow-lg border border-gray-200">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">UK Company Analysis Tool</h1>
        <p class="text-gray-600 mb-6 text-center">
            Enter a UK company name and its ERP solution to generate a tailored business analysis.
        </p>

        <!-- Input and button section -->
        <div class="mb-4">
            <label for="companyName" class="block text-sm font-medium text-gray-700 mb-2">Company Name:</label>
            <input type="text" id="companyName" class="w-full px-4 py-2 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all" placeholder="e.g., British Gas">
        </div>
        <div class="mb-6">
            <label for="erpSolution" class="block text-sm font-medium text-gray-700 mb-2">ERP/Business Solution Name:</label>
            <input type="text" id="erpSolution" class="w-full px-4 py-2 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all" placeholder="e.g., Sage 200, Monday.com">
        </div>
        <div class="flex justify-center">
            <button id="generateButton" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all">
                Generate Analysis
            </button>
        </div>

        <!-- Loading indicator -->
        <div id="loading" class="loading-container mt-8">
            <div class="dot-pulse"></div>
            <p class="text-indigo-600 mt-4">Generating your analysis...</p>
        </div>

        <!-- Output section -->
        <div id="output" class="mt-8 p-6 bg-white rounded-xl border border-gray-200 hidden">
            <div id="introductionSection"></div>
            <div id="involvementSection" class="mt-6"></div>
            <div id="erpSection" class="mt-6"></div>
            <div id="fsmSection" class="mt-6"></div>
        </div>

        <!-- Error/info message box -->
        <div id="messageBox" class="mt-8 p-4 text-sm text-red-700 bg-red-100 rounded-lg hidden"></div>

    </div>

    <script type="module">
        // Import the necessary Firebase modules. This assumes the Canvas environment provides them.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Global variables provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Check if Firebase is configured before initializing.
        let app;
        if (Object.keys(firebaseConfig).length > 0) {
             app = initializeApp(firebaseConfig);
        }

        /**
         * Converts the text from the API into a structured format for display.
         * The API is expected to return the content with distinct sections.
         * @param {string} text - The raw text from the API.
         * @returns {object} An object containing the parsed sections.
         */
        function parseApiResponse(text) {
            const sections = text.split('###');
            const result = {};

            sections.forEach(section => {
                const lines = section.trim().split('\n');
                if (lines.length > 1) {
                    const title = lines[0].trim().replace('##', '').replace('#', '');
                    const content = lines.slice(1).join('\n').trim();
                    if (title.includes('Introduction')) {
                        result.introduction = content;
                    } else if (title.includes('Areas of Involvement')) {
                        result.involvement = content;
                    } else if (title.includes('ERP Solution Highlight')) {
                        result.erp = content;
                    } else if (title.includes('BigChange FSM')) {
                        result.fsm = content;
                    }
                }
            });
            return result;
        }

        /**
         * Displays a temporary message in a dedicated message box.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('success', 'error', 'info').
         */
        function showMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = 'mt-8 p-4 text-sm rounded-lg';
            if (type === 'error') {
                messageBox.classList.add('text-red-700', 'bg-red-100');
            } else if (type === 'success') {
                messageBox.classList.add('text-green-700', 'bg-green-100');
            } else {
                messageBox.classList.add('text-blue-700', 'bg-blue-100');
            }
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        /**
         * Constructs a rich HTML section with a title and content.
         * @param {string} title - The title of the section.
         * @param {string} content - The content of the section.
         * @returns {string} The complete HTML string for the section.
         */
        function createSectionHTML(title, content) {
            const paragraphs = content.split('\n\n').map(p => `<p class="mb-4">${p}</p>`).join('');
            return `
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b-2 border-indigo-200 pb-2">${title}</h2>
                <div>${paragraphs}</div>
            `;
        }

        document.getElementById('generateButton').addEventListener('click', async () => {
            const companyName = document.getElementById('companyName').value.trim();
            const erpSolution = document.getElementById('erpSolution').value.trim();
            const outputDiv = document.getElementById('output');
            const loadingDiv = document.getElementById('loading');

            if (!companyName || !erpSolution) {
                showMessage('Please enter both a company name and an ERP solution.', 'error');
                return;
            }

            // Show loading indicator and hide previous output
            outputDiv.classList.add('hidden');
            loadingDiv.style.display = 'flex';

            try {
                // The prompt for the LLM is now updated to include the ERP solution.
                const prompt = `
                    You are a business analyst. Provide a professional analysis of a UK company.
                    Please generate the response in four distinct sections.
                    
                    ### Introduction to ${companyName}
                    Provide a brief, professional introduction to ${companyName}, including its history and general market position in the UK.
                    
                    ### Areas of Involvement
                    Detail the key business sectors and areas where ${companyName} is involved.
                    
                    ### ERP Solution Highlight: ${erpSolution}
                    Provide a brief professional overview of the ${erpSolution} ERP solution, including its key features and common use cases.
                    
                    ### How BigChange FSM Could Integrate with ${erpSolution}
                    Analyze how implementing the BigChange Field Service Management (FSM) system could benefit ${companyName} by integrating with their existing ${erpSolution} solution. Discuss specific advantages of the BigChange platform, such as its "all-in-one" JobWatch system, intelligent scheduling and dispatch, real-time vehicle and job tracking, and mobile workforce app, and explain how data synchronization between the two systems would streamline operations, reduce manual data entry, and improve cash flow. The analysis should be detailed and relevant to a company of this nature.
                `;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    const parsedData = parseApiResponse(text);

                    document.getElementById('introductionSection').innerHTML = createSectionHTML('Introduction', parsedData.introduction || 'Could not generate introduction.');
                    document.getElementById('involvementSection').innerHTML = createSectionHTML('Areas of Involvement', parsedData.involvement || 'Could not generate areas of involvement.');
                    document.getElementById('erpSection').innerHTML = createSectionHTML(`ERP Solution Highlight: ${erpSolution}`, parsedData.erp || 'Could not generate ERP highlight.');
                    document.getElementById('fsmSection').innerHTML = createSectionHTML('How an FSM System from BigChange Could Integrate', parsedData.fsm || 'Could not generate FSM benefits analysis.');

                    outputDiv.classList.remove('hidden');
                } else {
                    showMessage('Sorry, I couldn\'t generate the analysis. Please try again.', 'error');
                }
            } catch (error) {
                console.error("Failed to fetch from API:", error);
                showMessage('An unexpected error occurred. Please check your input and try again.', 'error');
            } finally {
                loadingDiv.style.display = 'none';
            }
        });
    </script>
</body>
</html>
